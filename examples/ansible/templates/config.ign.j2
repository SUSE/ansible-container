{#- Based upon ignition config generated by https://opensuse.github.io/fuel-ignition/edit -#}
{%- set _keys = [] -%}
{%- for _kf in ssh_pub_keys | default([]) -%}
{%-   set _ = _keys.append(lookup('ansible.builtin.file', _kf)) -%}
{%- endfor -%}
{%- set unique_keys = _keys | sort | unique -%}
{
  "ignition": {
    "version": "3.2.0"
  },
  "passwd": {
    "users": [
      {
        "name": "root",
{% if (unique_keys | length) > 0 %}
        "sshAuthorizedKeys": {{ unique_keys | to_json }},
{% endif %}
	{# Password is the user's name #}
        "passwordHash": "$2a$10$FbGb5ARQnuaHiskxcYIOgO9PADKyymvmioHMCoHdfO.eyYePLqBZ2"
      },
      {
        "name": "test",
{% if (unique_keys | length) > 0 %}
        "sshAuthorizedKeys": {{ unique_keys | to_json }},
{% endif %}
	{# Password is the user's name #}
        "passwordHash": "$2a$10$WK21CVEDrqW4QB5FmmeCjuvFlJl7NMCYGRqBCg/WR1932ua8igzIa"
      }
    ]
  },
  "storage": {
    "filesystems": [
      {
        "device": "/dev/disk/by-label/ROOT",
        "format": "btrfs",
        "mountOptions": [
          "subvol=/@/home"
        ],
        "path": "/home",
        "wipeFilesystem": false
      }
    ],
    "files": [
      {
        "path": "/etc/hostname",
        "mode": 420,
        "overwrite": true,
        "contents": {
          "source": "data:text/plain;charset=utf-8;base64,{{ appliance.name | b64encode }}"
        }
      },
      {
        "path": "/etc/sudoers.d/test",
        "mode": 420,
        "overwrite": true,
        "contents": {
          "source": "data:text/plain;charset=utf-8;base64,{{ 'test ALL=(ALL:ALL) NOPASSWD:ALL' | b64encode }}"
        }
      }
    ]
  }
}
