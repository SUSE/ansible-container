---
- hosts: all
  tasks:
    - name: site | hello world
      shell: echo "Hi! Ansible is working"

    - name: Gather the package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Print the package facts
      ansible.builtin.debug:
        var: ansible_facts.packages

    - name: Ensure NetworkManager is installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: present
      become: true
      with_items:
        - NetworkManager

    - name: Deactivate Wireless Network Interfaces
      command: nmcli radio wifi off
      become: true
      when: "'NetworkManager' in ansible_facts.packages"

    - name: test ssh
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
      delegate_to: localhost

    - name: test webpage access
      uri:
        url: https://www.example.com
        return_content: yes
      register: webpage

    - name: check fail webpage contents
      fail:
        msg: 'service is not happy'
      when: "'AWESOME' not in webpage.content"

    - name: check pass webpage contents
      fail:
        msg: 'service is not happy'
      when: "'This domain is for use in illustrative examples in documents' not in webpage.content"
